<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>three.js</title>
		<style>
			body { margin: 0; background-color: #181818; overflow: hidden; }
			canvas { width: 100%; height: 100% };
			a { color: #ffffff; }
			#oldie a { color:#da0 }
		</style>
	</head>
	<body>
		<!-- where the content goes -->
		<div id="container">
		</div>

		<!-- javascript libs at the end -->
		<script src="jquery-1.8.2.min.js"></script>
		<script src="three.min.js"></script>
		<script src="Detector.js"></script>
		<script src="OrbitControls.js"></script>
		<script src="physi.js"></script>

		<!-- rendering -->
		<script>
			'use strict';

			Physijs.scripts.worker = 'physijs_worker.js';
			Physijs.scripts.ammo = 'ammo.js';

			// set the scene size
			var WIDTH = window.innerWidth,
			  HEIGHT = window.innerHeight;

			// set some camera attributes
			var VIEW_ANGLE = 45,
			  ASPECT = WIDTH / HEIGHT,
			  NEAR = 0.1,
			  FAR = 10000;

			// get the DOM element to attach to
			var container = $('#container');
			var renderer, camera, scene, controls;

			////////////////////////////////////////////////////////////////////////////////////////////

			// Can we start?
			if (!Detector.webgl){
				Detector.addGetWebGLMessage();

				if (Detector.canvas){
					window.setTimeout(Detector.removeGetWebGLMessage, 5000);
					window.setTimeout(init, 5500);
				}
				return;
			}
			else{
				init();
			}

			////////////////////////////////////////////////////////////////////////////////////////////

			// Init and start
			function init(){
				// create a WebGL renderer, camera
				// and a scene
				if (Detector.webgl){
					renderer = new THREE.WebGLRenderer({
						antialias: true,
						preserveDrawingBuffer   : true  // required to support .toDataURL()
					});

					renderer.setFaceCulling("back");
				}
				else if (Detector.canvas){
					renderer = new THREE.CanvasRenderer();
				}

				renderer.setClearColorHex(0x181818);

				camera =
				  new THREE.PerspectiveCamera(
				    VIEW_ANGLE,
				    ASPECT,
				    NEAR,
				    FAR);

				scene = new Physijs.Scene;
				scene.setGravity(new THREE.Vector3(0, 0, 0)); // Turn off gravity

				// add the camera to the scene
				scene.add(camera);

				// the camera starts at 0,0,0
				// so pull it back
				camera.position.z = 300;

				// start the renderer
				renderer.setSize(WIDTH, HEIGHT);

				// attach the render-supplied DOM element
				container.append(renderer.domElement);

				// Set everything else up
				setupControls();
				setupObjects();
				setupLights();

				// Start rendering!
				render();
			}

			////////////////////////////////////////////////////////////////////////////////////////////

			function setupControls(){
				controls = new THREE.OrbitControls( camera ); // Camera controls

				// Other keyboard controls
				document.addEventListener('keydown', function(event){
					if (event.altKey){
						return;
					}

					//event.preventDefault();

					switch (event.keyCode){

						case 80: /*P*/
							// http://learningthreejs.com/blog/2011/09/03/screenshot-in-javascript/
							var dataUrl = renderer.domElement.toDataURL("image/png");
							window.open(dataUrl, '_screenshot');
							break;

					}
				},
				false );
			}

			////////////////////////////////////////////////////////////////////////////////////////////

			var sphere, cube;
			function setupObjects(){
				// set up the sphere vars
				var radius = 50,
				    segments = 24,
				    rings = 24;

				// create the sphere's material
				var sphereMaterial =
				  new THREE.MeshLambertMaterial(
				    {
				      color: 0xCC0000
				    });

				// create a new mesh with
				// sphere geometry
				sphere = new Physijs.SphereMesh(

				  new THREE.SphereGeometry(
				    radius,
				    segments,
				    rings),

				  sphereMaterial,

				  0 // 0 mass, so it doesn't move
				 );

				// add the sphere to the scene
				sphere.position.x = -100;
				scene.add(sphere);

				// Add a green cube
				var cubeGeometry = new THREE.CubeGeometry(50, 50, 50);
				var cubeMaterial = new THREE.MeshLambertMaterial({color: 0x00ff00});
				cube = new Physijs.BoxMesh(cubeGeometry, cubeMaterial);
				cube.position.x = 100;
				scene.add(cube);
			}

			////////////////////////////////////////////////////////////////////////////////////////////

			function setupLights(){
				// create a point light
				var pointLight =
				  new THREE.PointLight(0xFFFFFF);

				// set its position
				pointLight.position.x = 10;
				pointLight.position.y = 50;
				pointLight.position.z = 130;

				// add to the scene
				scene.add(pointLight);
			}

			////////////////////////////////////////////////////////////////////////////////////////////
			
			// draw!
			function render(){
				requestAnimationFrame(render); // 60fps, but pauses if we tab away

				scene.simulate(); // run physics

				controls.update(); // controls

				// Spin the sphere
				sphere.rotation.y += 0.01;
				sphere.__dirtyRotation = true; // we moved the sphere manually, so let the simulation know

				renderer.render(scene, camera);
			}

			////////////////////////////////////////////////////////////////////////////////////////////
		</script>
	</body>
</html>